version: "3.9"

services:
  xhs-reporter:
    build: .
    image: xhs-reporter:latest
    env_file:
      - .env           # OPENROUTER_API_KEY 等
      - ./secrets.env  # R2/Bark 密钥等
    volumes:
      - .:/app
    restart: "no"

  xhs-reporter-cron:
    image: xhs-reporter:latest
    env_file:
      - .env
      - ./secrets.env
    command: |
      /bin/sh -c '
        # then schedule daily at 17:00 UTC
        while true; do
          now=$(date -u +%s)
          target=$(date -u -d "today 17:00" +%s 2>/dev/null)
          if [ -z "$target" ]; then
            target=$(( now + 86400 ))
          fi
          if [ "$now" -ge "$target" ]; then
            target=$(date -u -d "tomorrow 17:00" +%s 2>/dev/null)
            if [ -z "$target" ]; then
              target=$(( now + 86400 ))
            fi
          fi
          sleep $(( target - now ))
          /app/docker-entrypoint.sh
        done
      '
    volumes:
      - .:/app
    restart: unless-stopped
